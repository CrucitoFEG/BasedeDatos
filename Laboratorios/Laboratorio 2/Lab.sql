-- CREACIÓN DE TABLAS, INSERSION DE REGISTROS Y CONUSLTAS
-- 7690 23 5339 CRUZ FRANCISCO ESTRADA


CREATE TABLE proveedor (
    S# VARCHAR2(5) PRIMARY KEY,
    nombre VARCHAR2(50),
    status NUMBER(3),
    ciudad VARCHAR2(30),
    estado VARCHAR2(30)
);

CREATE TABLE pieza (
    id_pieza VARCHAR2(5) PRIMARY KEY,
    descripcion_pieza VARCHAR2(100),
    weight NUMBER(6,2),
    lenght NUMBER(6,2),
    color VARCHAR2(20)
);

CREATE TABLE parte (
    P# VARCHAR2(5) PRIMARY KEY,
    nombre VARCHAR2(50),
    ciudad VARCHAR2(30)
);

CREATE TABLE parte_abastecida (
    S# VARCHAR2(5),
    P# VARCHAR2(5),
    Qty NUMBER(6),
    PRIMARY KEY (S#, P#),
    FOREIGN KEY (S#) REFERENCES proveedor(S#),
    FOREIGN KEY (P#) REFERENCES parte(P#)
);

CREATE TABLE alumno (
    nro_carnet VARCHAR2(10) PRIMARY KEY,
    nombres VARCHAR2(50),
    apellidos VARCHAR2(50)
);

CREATE TABLE nota (
    id_nota NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    nro_carnet VARCHAR2(10),
    semestre VARCHAR2(10),
    nota_total NUMBER(5,2),
    FOREIGN KEY (nro_carnet) REFERENCES alumno(nro_carnet)
);

-- SE INSERTAN REGISTROS DE EJEMPLO
INSERT INTO proveedor VALUES ('S1','Carlos',10,'PARIS',NULL);
INSERT INTO proveedor VALUES ('S2','Carmen',20,'LONDRES','Activo');
INSERT INTO proveedor VALUES ('S3','Pedro',30,'PARIS','Activo');
INSERT INTO proveedor VALUES ('S4','Ana',40,'ROMA',NULL);

INSERT INTO pieza VALUES ('P1','Tornillo',11.85,5.6,'Rojo');
INSERT INTO pieza VALUES ('P2','Tuerca',16.78,3.2,'Azul');
INSERT INTO pieza VALUES ('P3','Clavo',9.23,7.1,'Verde');

INSERT INTO parte VALUES ('PA1','Parte A','PARIS');
INSERT INTO parte VALUES ('PA2','Parte B','LONDRES');
INSERT INTO parte VALUES ('PA3','Parte C','ROMA');

INSERT INTO parte_abastecida VALUES ('S1','PA1',100);
INSERT INTO parte_abastecida VALUES ('S2','PA2',200);
INSERT INTO parte_abastecida VALUES ('S3','PA1',150);
INSERT INTO parte_abastecida VALUES ('S4','PA3',300);

INSERT INTO alumno VALUES ('A001','Luis','García');
INSERT INTO alumno VALUES ('A002','María','Lopez');

INSERT INTO nota (nro_carnet, semestre, nota_total) VALUES ('A001','01-2025',75);
INSERT INTO nota (nro_carnet, semestre, nota_total) VALUES ('A001','02-2025',85);
INSERT INTO nota (nro_carnet, semestre, nota_total) VALUES ('A002','02-2025',90);

COMMIT;

-- CONSULTAS


SELECT prv.S#, prv.status
FROM proveedor prv
WHERE prv.ciudad = 'PARIS'
ORDER BY prv.status;

SELECT pzs.id_pieza, 'Peso en gramos = ' || (pzs.weight * 460) AS peso_total
FROM pieza pzs
ORDER BY pzs.weight * 460 DESC;

SELECT s.*, p.*
FROM proveedor s, parte p
WHERE s.ciudad = p.ciudad;

SELECT s.*, p.*
FROM proveedor s, parte p
WHERE s.ciudad = p.ciudad
AND s.status != 20;

SELECT s.S# AS id_proveedor, p.P# AS id_parte
FROM proveedor s, parte p
WHERE s.ciudad = p.ciudad;

SELECT DISTINCT s.ciudad, p.ciudad
FROM proveedor s, parte p, parte_abastecida sp
WHERE s.S# = sp.S#
AND p.P# = sp.P#;

SELECT P#, SUM(Qty)
FROM parte_abastecida
GROUP BY P#;

SELECT a.nro_carnet, a.nombres, a.apellidos, AVG(n.nota_total) AS promedio
FROM alumno a, nota n
WHERE a.nro_carnet = n.nro_carnet
GROUP BY a.nro_carnet, a.nombres, a.apellidos;

SELECT a.nro_carnet, a.nombres, a.apellidos, AVG(n.nota_total) AS promedio
FROM alumno a, nota n
WHERE a.nro_carnet = n.nro_carnet
AND n.semestre = '02-2025'
GROUP BY a.nro_carnet, a.nombres, a.apellidos
HAVING AVG(n.nota_total) >= 80;

SELECT p.*
FROM proveedor p
WHERE p.nombre LIKE 'C%'
   OR p.nombre LIKE 'c%';

SELECT S#
FROM proveedor s
WHERE estado IS NULL;
